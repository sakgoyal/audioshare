<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<meta name="color-scheme" content="dark light">
	<title>Audio Share</title>
	<style>
		:root {
			color-scheme: dark light;
		}

		body {
			display: flex;
			flex-direction: column;
			gap: 1rem;
			font-family: sans-serif;
			padding: 1rem;
			max-width: 800px;
			margin: auto;
		}

		#clients-list {
			padding: 1rem;
			display: flex;
			flex-direction: column;
			align-items: flex-start;
		}

		.row {
			display: flex;
			justify-content: space-between;
			align-items: center;
			border: 1px solid #ccc;
			padding: 0.5rem;
			width: 100%;
			box-sizing: border-box;
		}

		.client-row {
			cursor: pointer;
			transition: background-color 0.2s;
		}

		.client-row:hover {
			background-color: rgba(255, 255, 255, 0.1);
		}

		.client-row.playing {
			border-color: #4caf50;
			background-color: rgba(76, 175, 80, 0.1);
		}

		.row h2 {
			margin: 0;
			font-size: 1.2rem;
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
			padding-right: 1rem;
		}

		button:disabled {
			opacity: 0.5;
			cursor: not-allowed;
		}
	</style>
</head>

<body>
	<h1>Audio Files</h1>
	<div id="audio-container"></div>
	<h1>Connected Clients</h1>
	<div id="clients-list"></div>
</body>

<script>
	function setupPassword() {
		if (!localStorage.getItem('groupID')) {
			const val = prompt('Enter a complicated ascii password:');
			if (val) localStorage.setItem('groupID', val);
		}
		return localStorage.getItem('groupID');
	}
	const groupID = setupPassword();
</script>

<script type="importmap">
	{
		"imports": {
			"socket.io-client": "https://cdn.socket.io/4.8.1/socket.io.esm.min.js"
		}
	}
</script>

<script type="module">
	import { io } from 'socket.io-client';
	const socket = io('ws://localhost:3000');
	let myClientID = null;
	let isProgrammaticChange = false;
	let allClients = {}; // clientID -> { isPlaying: boolean, currentTrack: string }

	function getActiveAudio() {
		return [...document.querySelectorAll('audio')].find((a) => !a.paused);
	}

	function renderClients() {
		const clientsList = document.getElementById('clients-list');
		clientsList.innerHTML = '';

		const sortedClientIDs = Object.keys(allClients).sort();

		for (const clientID of sortedClientIDs) {
			const client = allClients[clientID];
			const isSelf = clientID === myClientID;
			const shortID = clientID.substring(0, 8);

			const row = document.createElement('div');
			row.className = `row client-row ${client.isPlaying ? 'playing' : ''}`;

			const statusText = client.isPlaying ? `Playing: ${client.currentTrack}` : 'Idle';
			row.innerHTML = `
				<div>
					<strong>${shortID}${isSelf ? ' (You)' : ''}</strong><br>
					<small style="color: ${client.isPlaying ? '#4CAF50' : '#999'}">${statusText}</small>
				</div>
			`;

			row.onclick = () => {
				if (isSelf) {
					socket.emit('pullRequest', { sourceClientID: 'any' });
				} else {
					const activeAudio = getActiveAudio();
					if (activeAudio) {
						socket.emit('transferRequest', {
							targetClientID: clientID,
							state: {
								filename: activeAudio.filename,
								time: activeAudio.currentTime,
								isPlaying: !activeAudio.paused,
							},
						});
					}
				}
			};

			clientsList.appendChild(row);
		}
	}

	socket.on('connect', () => {
		console.log('Socket.IO connection opened:', socket.id);
		if (groupID) {
			socket.emit('register', groupID);
		}
	});

	socket.on('registered', ({ clientID, existingClients }) => {
		myClientID = clientID;
		console.log('Registered with ID:', myClientID);
		document.title = `Audio Share - ${myClientID.substring(0, 8)}`;

		// Initialize all clients
		allClients[myClientID] = { isPlaying: false, currentTrack: null };
		existingClients.forEach((id) => {
			allClients[id] = { isPlaying: false, currentTrack: null };
		});
		renderClients();
	});

	socket.on('newClient', (clientID) => {
		console.log('New client joined:', clientID);
		allClients[clientID] = { isPlaying: false, currentTrack: null };
		renderClients();
	});

	socket.on('clientLeft', (clientID) => {
		console.log('Client left:', clientID);
		delete allClients[clientID];
		renderClients();
	});

	socket.on('clientStates', (states) => {
		console.log('Received client states:', states);
		// Simply replace our client states with server's authoritative state
		allClients = { ...states };
		renderClients();
	});

	socket.on('filesList', (files) => {
		const audioContainer = document.getElementById('audio-container');
		audioContainer.innerHTML = '';
		for (const file of files) {
			const row = document.createElement('div');
			row.className = 'row';
			const h2 = document.createElement('h2');
			h2.textContent = file;
			const audio = document.createElement('audio');
			audio.controls = true;
			audio.src = `/${file}`;
			audio.preload = 'none';
			audio.filename = file;
			audio.onplay = onplay;
			audio.onpause = onpause;
			audio.onseeked = onseeked;
			row.appendChild(h2);
			row.appendChild(audio);
			audioContainer.appendChild(row);
		}
	});

	socket.on('stateUpdate', (state) => {
		const { filename, time, type, clientID } = state;
		const audioToUpdate = [...document.querySelectorAll('audio')].find((a) => a.filename === filename);
		if (audioToUpdate) {
			isProgrammaticChange = true;
			if (type === 'play') {
				document.querySelectorAll('audio').forEach((a) => {
					if (a !== audioToUpdate) {
						a.pause();
						a.currentTime = 0;
					}
				});
			}
			audioToUpdate.currentTime = time;
			setTimeout(() => isProgrammaticChange = false, 100);
		}
		renderClients();
	});

	socket.on('applyState', (state) => {
		const audioToApply = [...document.querySelectorAll('audio')].find((a) => a.filename === state.filename);
		if (audioToApply) {
			isProgrammaticChange = true;
			document.querySelectorAll('audio').forEach((a) => {
				if (a !== audioToApply) a.pause();
			});
			audioToApply.currentTime = state.time;
			if (state.isPlaying) {
				audioToApply.play().catch((e) => console.error('Play was interrupted:', e));
			} else {
				audioToApply.pause();
			}
			setTimeout(() => isProgrammaticChange = false, 100);
		}
		renderClients();
	});

	socket.on('pausePlayback', () => {
		const activeAudio = [...document.querySelectorAll('audio')].find((a) => !a.paused);
		if (activeAudio) {
			isProgrammaticChange = true;
			activeAudio.pause();
			setTimeout(() => isProgrammaticChange = false, 100);
		}
		renderClients();
	});

	socket.on('requestCurrentState', (requestingClientID) => {
		const activeAudio = getActiveAudio();
		if (activeAudio) {
			const state = {
				filename: activeAudio.filename,
				time: activeAudio.currentTime,
				isPlaying: !activeAudio.paused,
			};
			socket.emit('transferRequest', { targetClientID: requestingClientID, state });
		}
	});

	function sendStateUpdate(event, type) {
		if (isProgrammaticChange) return;
		socket.emit(type, {
			time: event.target.currentTime,
			filename: event.target.filename,
		});
	}

	const onseeked = (event) => sendStateUpdate(event, 'seeked');

	const onplay = (event) => {
		if (isProgrammaticChange) return;
		const targetAudio = event.target;
		document.querySelectorAll('audio').forEach((audio) => {
			if (audio !== targetAudio) {
				audio.pause();
				audio.currentTime = 0;
			}
		});
		sendStateUpdate(event, 'play');
	};

	const onpause = (event) => {
		sendStateUpdate(event, 'pause');
	};
</script>
